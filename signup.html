<!DOCTYPE html> 
<html lang="en"> 
<head> 
  <meta charset="UTF-8" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0" /> 
  <title>CapsuleX - Sign Up</title> 
  <link rel="stylesheet" href="style.css" />
  <script>
    window.addEventListener('beforeunload', () => {
      sessionStorage.removeItem('videoPlayed');
    });
  </script>
</head> 

<body> 
  <div class="caption1">Hey Stalker!</div> 
  <div class="caption2">Say it without saying who you are.</div> 
  <div class="intro-logo">capsule<span class="grey-x">X</span></div> 

  <input type="text" id="name" placeholder="Name" autocomplete="new-password" /> 
  <input type="email" id="email" placeholder="Email address" autocomplete="new-password" /> 
  <input type="password" id="password" placeholder="Password" autocomplete="new-password" /> 
  <button id="signupBtn">Sign Up</button> 

  <div id="signupMessage" class="form-message"></div>

  <div class="or-text">OR</div> 
  <a href="login.html" class="signup-link">log in</a> 

  <script>
    document.getElementById("signupBtn").addEventListener("click", async function () {
      const name = document.getElementById("name").value;
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const msgDiv = document.getElementById("signupMessage");

      msgDiv.textContent = '';
      msgDiv.style.color = 'orange';

      try {
        const res = await fetch("https://capsule-x-backend.onrender.com/api/auth/signup", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email, password })
        });

        const result = await res.json();

        if (res.ok) {
          if (result.requiresVerification) {
            msgDiv.textContent = "✅ Please check your inbox to verify your account.";
            return;
          }

          // Attempt auto-login
          const loginRes = await fetch("https://capsule-x-backend.onrender.com/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password })
          });

          const loginData = await loginRes.json();

          if (loginRes.ok && loginData.token) {
            localStorage.setItem("token", loginData.token);
            localStorage.setItem("name", loginData.name || name);
            window.location.href = "dashboard.html";
          } else {
            // No popup — just redirect silently to login
            window.location.href = "login.html";
          }
        } else {
          msgDiv.textContent = result.error || "Signup failed.";
          msgDiv.style.color = "salmon";
        }
      } catch (err) {
        msgDiv.textContent = "Something went wrong. Try again.";
        msgDiv.style.color = "red";
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('name').value = '';
      document.getElementById('email').value = '';
      document.getElementById('password').value = '';
    });

    window.addEventListener('beforeunload', () => {
      sessionStorage.removeItem('videoPlayed');
    });
  </script>
</body> 
</html>